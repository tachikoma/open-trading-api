# 백테스트 시그널 분석 가이드

## 🔍 "초반에 거래가 안 되는" 문제 분석

### 원인 1: 이동평균 교차는 드문 이벤트

**골든크로스/데드크로스는 시장 추세가 크게 바뀔 때만 발생합니다.**

#### 실제 통계 (삼성전자, 1년 백테스트, MA20/60)
- 총 체크: 263회 (매일)
- **매수 시그널: 2회 (0.8%)**
- **매도 시그널: 2회 (0.8%)**
- 시그널 없음: 200회 (76%)
- 데이터 부족: 59회 (22.4%) - 초기 워밍업 기간

**결론**: 이동평균 교차 전략은 본질적으로 **거래 빈도가 낮은 전략**입니다.

### 원인 2: 긴 이동평균 기간 사용

| 이동평균 기간 | 교차 빈도 | 적합한 백테스트 기간 |
|-------------|----------|------------------|
| MA5/MA20 | 월 1~2회 | 6개월 ~ 1년 |
| MA20/MA60 | 2~3개월에 1회 | 1년 ~ 2년 |
| **MA50/MA200** | **3~6개월에 1회** | **2년 ~ 5년** |

**200일 이동평균 골든크로스**는 "장기 상승장 전환"을 의미하므로:
- 매우 드물게 발생 (년 1~2회)
- 단기 백테스트에서는 시그널이 없을 수 있음
- **최소 2~3년 데이터 필요**

### 원인 3: 워밍업 기간 부족 (✅ 해결됨)

초기 백테스트에서는 워밍업 데이터가 부족했으나, 현재는 해결되었습니다:

```python
# trading_bot/run_backtest.py
warmup_days = args.long_period
data_start_date = (datetime.strptime(start_date, "%Y%m%d") 
                   - timedelta(days=warmup_days * 3)).strftime("%Y%m%d")
```

- 200일 MA 사용 시: 600력일 전부터 데이터 로드
- 백테스트는 `start_date`부터만 실행
- 이동평균은 워밍업 데이터 포함하여 계산

## 💡 해결 방안

### 방법 1: 더 짧은 이동평균 사용 (추천)

**단기 거래를 원한다면:**
```bash
# MA5/MA20 전략 (주간 거래)
uv run run_backtest.py --source fdr \
    --start 20230101 --end 20241231 \
    --short-period 5 --long-period 20 \
    --symbols 005930 000660

# MA10/MA30 전략 (월간 거래)
uv run run_backtest.py --source fdr \
    --start 20220101 --end 20241231 \
    --short-period 10 --long-period 30 \
    --symbols 005930 000660
```

### 방법 2: 더 긴 백테스트 기간 (MA50/200 전략용)

```bash
# 3년 백테스트 - 200일 MA 사용 시 권장
uv run run_backtest.py --source fdr \
    --start 20220101 --end 20241231 \
    --short-period 50 --long-period 200 \
    --symbols 005930 000660 035420

# 5년 백테스트 - 더 신뢰성 있는 결과
uv run run_backtest.py --source fdr \
    --start 20200101 --end 20241231 \
    --short-period 50 --long-period 200 \
    --symbols 005930 000660 035420
```

### 방법 3: 다중 종목으로 거래 기회 증가

```bash
# 10개 종목 - 각 종목에서 독립적으로 시그널 발생
uv run run_backtest.py --source fdr \
    --start 20230101 --end 20241231 \
    --short-period 20 --long-period 60 \
    --symbols 005930 000660 035420 005380 051910 \
             006400 035720 000270 068270 207940
```

**효과**: 종목 수가 많을수록 전체 거래 빈도 증가

### 방법 4: 전략 개선 - 포지션 유지 로직 추가

현재는 **교차 순간**에만 매수/매도하지만, 다음과 같이 개선 가능:

```python
# 개선 아이디어 (strategies/ma_crossover.py)
if current_short > current_long:
    # 이미 골든크로스 상태면
    if not self.has_position(symbol):
        return {'action': 'buy', 'reason': '상승 추세 진입'}
elif current_short < current_long:
    # 이미 데드크로스 상태면
    if self.has_position(symbol):
        return {'action': 'sell', 'reason': '하락 추세 진입'}
```

## 📊 시그널 통계 해석

백테스트 로그의 시그널 통계를 보면:

```
=== 시그널 통계 ===
총 체크: 263회
  매수 시그널: 2회 (0.8%)
  매도 시그널: 2회 (0.8%)
  시그널 없음: 200회 (76.0%)
  데이터 부족: 59회 (22.4%)
```

**정상 동작 기준**:
- ✅ **데이터 부족 < 30%**: 워밍업 기간 적절
- ✅ **시그널 있음 > 0%**: 전략이 작동 중
- ⚠️ **시그널 < 5%**: 이동평균 교차 전략의 정상적인 특성

**문제가 있는 경우**:
- ❌ **데이터 부족 = 100%**: 워밍업 기간이 전혀 없음
- ❌ **시그널 = 0%**: 기간이 너무 짧거나 시장이 횡보장

## 🎯 전략별 권장 설정

### 단기 트레이딩 (주 1~2회 거래)
```bash
--short-period 5 --long-period 20
--start 20230701  # 1.5년 백테스트
```

### 중기 스윙 트레이딩 (월 1~2회 거래)
```bash
--short-period 20 --long-period 60
--start 20230101  # 2년 백테스트
```

### 장기 추세 추종 (분기 1~2회 거래)
```bash
--short-period 50 --long-period 200
--start 20200101  # 5년 백테스트 권장
```

## 🔧 디버깅 팁

### 1. 시그널 발생 확인

로그 레벨을 DEBUG로 설정하면 매일의 상태를 볼 수 있습니다:

```python
# trading_bot/config.py
LOG_LEVEL = "DEBUG"  # INFO -> DEBUG로 변경
```

### 2. 특정 기간 상세 분석

초반 10일과 마지막 10일은 자동으로 디버그 모드로 실행됩니다:

```
[005930] 시그널 없음 - 상승세 (단기: 82150, 장기: 81200)
[005930] 골든크로스 (단기MA: 82500, 장기MA: 82300)
[005930] 시그널 없음 - 상승세 (단기: 83000, 장기: 82500)
```

### 3. 이동평균 차트 확인

백테스트 결과 차트에서 이동평균선을 확인:
- 파란선(단기 MA)과 주황선(장기 MA)의 교차 지점 확인
- 교차가 드문 것이 정상

## 📚 더 알아보기

- [백테스트 빠른 시작](QUICKSTART.md)
- [데이터 소스 가이드](backtest/DATA_SOURCES.md)
- [전략 개발 가이드](IMPLEMENTATION.md)

---

**핵심 요약**: 
- 이동평균 교차 전략은 **본질적으로 거래 빈도가 낮습니다**
- MA50/200은 **장기 전략**으로 2~3년 백테스트 필요
- 더 많은 거래를 원하면 **더 짧은 이동평균** 사용 (MA5/20, MA10/30)
- 워밍업 기간 문제는 이미 해결되었습니다 ✅
